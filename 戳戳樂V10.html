<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物理戳戳樂</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FEF3C7; /* bg-amber-100 */
        }
        .game-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .game-card:hover {
            transform: scale(1.05);
        }
        .game-card.opened {
            background-color: #FDE68A; /* bg-amber-200 */
            cursor: not-allowed;
            opacity: 0.6;
        }
        .game-card.opened .ghost {
            opacity: 0.3;
        }
        .modal-content {
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g fill="%23FBBF24" fill-opacity="0.1"><circle cx="50" cy="50" r="50"/><g transform="translate(50,50) scale(0.5,0.5)"><circle cx="0" cy="0" r="50"/><path d="M 0 -50 A 50 50 0 0 1 0 50" fill="%23F59E0B"/></g></g></svg>');
            background-repeat: no-repeat;
            background-position: top right;
        }
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-animation {
            animation: pop 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Setup Screen -->
    <div id="setup-screen" class="w-full max-w-md mx-auto p-8 bg-white/80 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-center text-amber-800 mb-6">遊戲設定</h1>
        <div class="space-y-4">
            <!-- 新增：關卡選擇 -->
            <div>
                <label for="level-select" class="block text-amber-800 font-bold mb-1">關卡選擇</label>
                <select id="level-select" class="w-full px-3 py-2 border border-amber-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500">
                    <option value="velocity">誰最懂速率篇</option>
                    <option value="acceleration" selected>誰最懂加速度篇</option>
                </select>
            </div>
            <div>
                <label for="class-id" class="block text-amber-800 font-bold mb-1">班級 (例如: 301)</label>
                <input type="number" id="class-id" class="w-full px-3 py-2 border border-amber-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" value="301">
            </div>
            <div>
                <label for="total-groups" class="block text-amber-800 font-bold mb-1">總共分幾組</label>
                <input type="number" id="total-groups" class="w-full px-3 py-2 border border-amber-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" value="6">
            </div>
            <div>
                <label for="start-group" class="block text-amber-800 font-bold mb-1">起始組別</label>
                <input type="number" id="start-group" class="w-full px-3 py-2 border border-amber-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" value="6">
            </div>
            <div>
                <label for="players-per-group" class="block text-amber-800 font-bold mb-1">每組輪流人數</label>
                <input type="number" id="players-per-group" class="w-full px-3 py-2 border border-amber-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" value="2">
            </div>
        </div>
        <button id="start-game-btn" class="mt-8 w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
            開始遊戲
        </button>
    </div>

    <!-- Game Screen (Initially Hidden) -->
    <div id="game-screen" class="w-full max-w-4xl mx-auto hidden">
        <h1 id="game-title" class="text-3xl md:text-4xl font-bold text-center text-amber-800 mb-2"></h1>
        <div id="turn-display" class="text-center text-xl font-bold text-red-600 mb-4 p-2 bg-white/60 rounded-lg"></div>
        <div id="game-board" class="grid grid-cols-7 gap-3 md:gap-4"></div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 md:p-8 text-center border-4 border-amber-400 transform transition-all scale-95 opacity-0">
            <div id="animation-container" class="min-h-[150px] flex items-center justify-center">
                <div id="gift-icon" class="hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><path d="M20 12v10H4V12"/><path d="M2 7h20v5H2z"/><path d="M12 22V7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>
                </div>
                <div id="prize-display" class="hidden">
                     <p id="prize-text" class="text-2xl md:text-3xl font-bold text-amber-900"></p>
                </div>
            </div>
            <button id="close-modal" class="mt-4 w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                繼續
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 遊戲設定區 ---
            // ‼️ 請在這裡貼上您從 Google Apps Script 取得的 Web App 網址
            const googleSheetWebAppUrl = 'https://script.google.com/macros/s/AKfycbzkYgTxIKRSGnz6EZLeTEqOd5zVrvQKPZU1rm0pA-YKnIzMCQhZWb3m2dQ8AJPaJXDJ/exec'; // 例如: 'https://script.google.com/macros/s/xxxxxxxxxxxxxxxxxxxx/exec'
            
            // --- 題庫區 ---
            const prizePools = {
                velocity: {
                    title: '戳戳樂 - 誰最懂速率篇',
                    prizes: [
                        { text: '向北方 每秒4公尺 持續3秒', count: 1 }, { text: '向北方 每秒3公尺 持續4秒', count: 3 },
                        { text: '向北方 每秒3公尺 持續3秒', count: 2 }, { text: '向北方 每秒2公尺 持續2秒', count: 2 },
                        { text: '向北方 每秒2公尺 持續3秒', count: 3 }, { text: '向北方 每秒1公尺 持續4秒', count: 2 },
                        { text: '向北方 每秒1公尺 持續3秒', count: 3 }, { text: '靜止 持續5秒', count: 3 },
                        { text: '再抽一次', count: 1 }, { text: '向南方 每秒4公尺 持續3秒', count: 1 },
                        { text: '向南方 每秒3公尺 持續4秒', count: 3 }, { text: '向南方 每秒3公尺 持續3秒', count: 2 },
                        { text: '向南方 每秒2公尺 持續2秒', count: 2 }, { text: '向南方 每秒2公尺 持續3秒', count: 3 },
                        { text: '向南方 每秒1公尺 持續4秒', count: 2 }, { text: '向南方 每秒1公尺 持續3秒', count: 3 },
                    ]
                },
                acceleration: {
                    title: '戳戳樂 - 誰最懂加速度篇',
                    prizes: [
                        { text: '開啟渦輪3秒，速度每秒增加2m/s', count: 2 },
                        { text: '引擎強化2秒，速度每秒增加2m/s', count: 2 },
                        { text: '引擎強化3秒，速度每秒增加3m/s', count: 2 },
                        { text: '開啟渦輪1秒，速度每秒增加5m/s', count: 2 },
                        { text: '無法使用道具，維持原來速度4秒', count: 2 },
                        { text: '無法使用道具，維持原來速度6秒', count: 2 },
                        { text: '無法使用道具，維持原來速度2秒', count: 2 },
                        { text: '開啟氮氣1秒，速度每秒增加5m/s', count: 2 },
                        { text: '開啟氮氣2秒，速度每秒增加3m/s', count: 2 },
                        { text: '瞬間輕量化5秒，速度每秒增加1m/s', count: 2 },
                        { text: '瞬間輕量化3秒，速度每秒增加1m/s', count: 2 },
                        { text: '後輪爆胎，速度每秒減少1m/s到靜止', count: 4 },
                        { text: '底盤抖動4秒，速度每秒減少2m/s', count: 2 },
                        { text: '底盤抖動2秒，速度每秒減少3m/s', count: 1 },
                        { text: '產生 3 m/s² 的反向加速度，持續4秒', count: 2 },
                        { text: '水箱過熱5秒，速度每秒減少1m/s', count: 2 },
                        { text: '水箱過熱3秒，速度每秒減少2m/s', count: 2 },
                    ]
                }
            };

            // --- 變數宣告 ---
            const setupScreen = document.getElementById('setup-screen');
            const gameScreen = document.getElementById('game-screen');
            const startGameBtn = document.getElementById('start-game-btn');
            const gameBoard = document.getElementById('game-board');
            const gameTitle = document.getElementById('game-title');
            const turnDisplay = document.getElementById('turn-display');
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            const giftIcon = document.getElementById('gift-icon');
            const prizeDisplay = document.getElementById('prize-display');
            const prizeText = document.getElementById('prize-text');
            const closeModalBtn = document.getElementById('close-modal');
            
            let gameSettings = {};
            let turnState = { currentGroup: 1, currentPlayer: 1, isGameOver: false };

            const punchSound = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' } }).toDestination();

            // --- 遊戲流程控制 ---
            startGameBtn.addEventListener('click', () => {
                gameSettings = {
                    level: document.getElementById('level-select').value,
                    classId: document.getElementById('class-id').value,
                    totalGroups: parseInt(document.getElementById('total-groups').value),
                    startGroup: parseInt(document.getElementById('start-group').value),
                    playersPerGroup: parseInt(document.getElementById('players-per-group').value),
                };

                if (!gameSettings.classId || !gameSettings.totalGroups || !gameSettings.startGroup || !gameSettings.playersPerGroup) {
                    alert('請填寫所有設定欄位！');
                    return;
                }

                turnState.currentGroup = gameSettings.startGroup;
                turnState.currentPlayer = 1;
                turnState.isGameOver = false;
                
                setupScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                initGame();
                updateTurnDisplay();
            });

            // --- 遊戲核心邏輯 ---
            function initGame() {
                gameBoard.innerHTML = ''; // 清空舊的遊戲板
                const currentLevelData = prizePools[gameSettings.level];
                gameTitle.textContent = currentLevelData.title;

                let prizePool = [];
                currentLevelData.prizes.forEach(p => { for (let i = 0; i < p.count; i++) prizePool.push(p.text); });
                
                const gridSize = gameSettings.level === 'acceleration' ? 35 : 36;
                const gridCols = gameSettings.level === 'acceleration' ? 'grid-cols-7' : 'grid-cols-6';
                gameBoard.className = `grid ${gridCols} gap-3 md:gap-4`;

                while (prizePool.length < gridSize) {
                    prizePool.push('銘謝惠顧');
                }

                const shuffledPrizes = shuffle(prizePool.slice(0, gridSize));

                const ghostColors = ['#F87171', '#60A5FA', '#34D399', '#FBBF24', '#A78BFA', '#EC4899'];
                shuffledPrizes.forEach((prize, index) => {
                    const card = document.createElement('div');
                    card.className = 'game-card aspect-square rounded-lg p-2 shadow-md';
                    card.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
                    card.dataset.prize = prize;
                    card.dataset.index = index + 1;
                    card.dataset.opened = 'false';
                    card.innerHTML = createGhostSVG(ghostColors[index % ghostColors.length], index);
                    card.addEventListener('click', () => handleCardClick(card));
                    gameBoard.appendChild(card);
                });
            }

            function handleCardClick(card) {
                if (card.dataset.opened === 'true' || turnState.isGameOver || !Tone.context.state === 'running') return;
                
                punchSound.triggerAttackRelease('C2', '8n');
                card.dataset.opened = 'true';
                card.classList.add('opened');
                
                showModalWithAnimation(card.dataset.prize);
                
                const groupNameForSheet = `${gameSettings.classId}-${turnState.currentGroup}`;
                const levelName = prizePools[gameSettings.level].title;
                logToGoogleSheet(groupNameForSheet, turnState.currentPlayer, card.dataset.index, card.dataset.prize, levelName);

                updateTurn();
            }
            
            function updateTurn() {
                const lastGroup = turnState.currentGroup;
                let nextGroup = lastGroup + 1;

                if (nextGroup > gameSettings.totalGroups) {
                    nextGroup = 1;
                }
                
                turnState.currentGroup = nextGroup;

                if (turnState.currentGroup === gameSettings.startGroup) {
                    turnState.currentPlayer++;
                }
                
                updateTurnDisplay();
            }
            
            function updateTurnDisplay() {
                if (turnState.currentPlayer > gameSettings.playersPerGroup) {
                    turnDisplay.textContent = '遊戲結束！所有人都已抽完。';
                    turnState.isGameOver = true;
                    return;
                }
                turnDisplay.textContent = `現在輪到 第 ${turnState.currentGroup} 組 的 第 ${turnState.currentPlayer} 位`;
            }

            function logToGoogleSheet(group, player, number, text, level) {
                if (!googleSheetWebAppUrl) {
                    console.log('尚未設定 Google Sheet Web App URL，紀錄將不會傳送。');
                    return;
                }
                const data = { group, player, number, text, level, timestamp: new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) };
                fetch(googleSheetWebAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => console.log(`紀錄已傳送至 Google Sheet 的 '${group}' 分頁。`))
                  .catch(error => console.error('傳送紀錄至 Google Sheet 失敗:', error));
            }

            // --- Helper & UI Functions ---
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            function createGhostSVG(color, index) {
                return `<svg viewBox="0 0 40 40" class="w-full h-full ghost"><path d="M38,20c0,9.9-8.1,18-18,18S2,29.9,2,20S10.1,2,20,2S38,10.1,38,20z" fill="${color}"/><path d="M38,20v18h-4.5v-4.5h-4.5v4.5h-4.5v-4.5h-4.5v4.5h-4.5v-4.5h-4.5v4.5H2V20" fill="${color}"/><circle cx="13" cy="18" r="4" fill="#fff"/><circle cx="27" cy="18" r="4" fill="#fff"/><circle cx="14" cy="19" r="2" fill="#000"/><circle cx="26" cy="19" r="2" fill="#000"/><text x="50%" y="12" dominant-baseline="middle" text-anchor="middle" font-size="10px" font-weight="bold" fill="#000" opacity="0.6">${index + 1}</text></svg>`;
            }
            function showModalWithAnimation(prize) {
                prizeText.textContent = prize;
                giftIcon.classList.remove('hidden');
                giftIcon.classList.add('pop-animation');
                prizeDisplay.classList.add('hidden');
                modal.classList.remove('hidden');
                setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
                setTimeout(() => {
                    giftIcon.classList.add('hidden');
                    giftIcon.classList.remove('pop-animation');
                    prizeDisplay.classList.remove('hidden');
                }, 600);
            }
            function hideModal() {
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }
            closeModalBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

            const startAudio = async () => {
                await Tone.start();
                document.body.removeEventListener('click', startAudio);
                document.body.removeEventListener('touchend', startAudio);
            };
            document.body.addEventListener('click', startAudio);
            document.body.addEventListener('touchend', startAudio);
        });
    </script>
</body>
</html>
